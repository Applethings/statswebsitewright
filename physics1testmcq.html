<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Physics 1 2023 MCQ</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: url('images/bgg.gif') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content {
            background-color: rgba(0, 0, 32, 0.6);
            padding: 40px;
            margin: 40px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .navigation {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 20px;
            background-color: rgba(0, 0, 32, 0.4);
            padding: 10px 20px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }
        .nav-button {
            background-color: rgba(0, 0, 128, 0.3);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: rgba(0, 0, 128, 0.5);
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 128, 0.6);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: rgba(0, 0, 128, 0.8);
        }
        .question-container {
            margin-bottom: 30px;
        }
        .question-text {
            margin-bottom: 20px;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .option {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .option:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .option.selected {
            background-color: rgba(0, 128, 0, 0.3);
        }
        .question-image {
            max-width: 100%;
            height: auto;
            margin: 20px 0;
            border-radius: 5px;
        }
        .page-number {
            color: white;
            margin: 0 20px;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: rgba(0, 0, 32, 0.95);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            color: white;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }
        
        #submitAnonymous {
            background-color: #666;
        }
        
        #submitWithName {
            background-color: #004d00;
        }
        
        #cancelSubmit {
            background-color: #660000;
        }
    </style>
</head>
<body>
    <a href="physics1.html" class="back-button">Back</a>
    
    <div class="content">
        <div class="page active" id="page1">
            <h1>AP Physics 1 2023 Multiple Choice Questions</h1>
            <h2>Section I</h2>
            <h3>Time—1 hour and 30 minutes</h3>
            <h3>50 Questions</h3>
            <br>
            <h3>Directions:</h3>
            <p>Each of the questions or incomplete statements below is followed by four suggested answers or completions. Select the one that is best in each case.</p>
        </div>

        <div class="page" id="page2">
            <div class="question-container">
                <h3>Question 1</h3>
                <div class="question-text">
                    <p>An object is moving to the right with speed v<sub>i</sub> when a force of magnitude F is exerted on it. In which of the following situations is the object's direction of motion changing and its kinetic energy decreasing at the instant shown?</p>
                    <img src="images/image11.png" alt="Four diagrams showing different force scenarios" class="question-image">
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(1, 0)">
                        <p>A) The force is directed upward</p>
                    </div>
                    <div class="option" onclick="selectOption(1, 1)">
                        <p>B) The force is directed to the left</p>
                    </div>
                    <div class="option" onclick="selectOption(1, 2)">
                        <p>C) The force is directed at an angle above the horizontal</p>
                    </div>
                    <div class="option" onclick="selectOption(1, 3)">
                        <p>D) The force is directed at an angle below the horizontal</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page3">
            <div class="question-container">
                <h3>Question 2</h3>
                <div class="question-text">
                    <p>A ball is suspended by a lightweight string, as shown in the figure above. The ball is displaced to position 1 and released. The four labeled positions are evenly spaced along the arc of the ball's motion. Between which adjacent pairs of positions is the change in kinetic energy of the ball greatest?</p>
                    <img src="images/image12.png" alt="Diagram showing the positions of the ball" class="question-image">
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(2, 0)">
                        <p>A) 1 and 2</p>
                    </div>
                    <div class="option" onclick="selectOption(2, 1)">
                        <p>B) 2 and 3</p>
                    </div>
                    <div class="option" onclick="selectOption(2, 2)">
                        <p>C) 3 and 4</p>
                    </div>
                    <div class="option" onclick="selectOption(2, 3)">
                        <p>D) The change is the same for all adjacent pairs.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page4">
            <div class="question-container">
                <h3>Question 3</h3>
                <div class="question-text">
                    <p>A newly discovered planet is found to have density \( \frac{2}{3} \rho_E \) and radius \( 2R_E \), where \( \rho_E \) and \( R_E \) are the density and radius of Earth, respectively. The surface gravitational field of the planet is most nearly</p>
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(3, 0)">
                        <p>A) 1.7 N/kg</p>
                    </div>
                    <div class="option" onclick="selectOption(3, 1)">
                        <p>B) 3.3 N/kg</p>
                    </div>
                    <div class="option" onclick="selectOption(3, 2)">
                        <p>C) 6.7 N/kg</p>
                    </div>
                    <div class="option" onclick="selectOption(3, 3)">
                        <p>D) 13 N/kg</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page5">
            <div class="question-container">
                <h3>Question 4</h3>
                <div class="question-text">
                    <p>A bus is initially traveling north at a constant speed, as shown in the figure above. As the bus starts to make a left turn without changing speed, a passenger notices that a box on the floor starts sliding toward the right side of the bus. Which of the following top views of the box, when correctly labeled, would best represent all of the horizontal forces exerted on the box as it starts sliding?</p>
                    <img src="images/image13.png" alt="Diagram showing the top views of the box" class="question-image">
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(4, 0)">
                        <p>A) <img src="images/question4a.png" alt="Option A" class="question-image"></p>
                    </div>
                    <div class="option" onclick="selectOption(4, 1)">
                        <p>B) <img src="images/question4b.png" alt="Option B" class="question-image"></p>
                    </div>
                    <div class="option" onclick="selectOption(4, 2)">
                        <p>C) <img src="images/question4c.png" alt="Option C" class="question-image"></p>
                    </div>
                    <div class="option" onclick="selectOption(4, 3)">
                        <p>D) <img src="images/question4d.png" alt="Option D" class="question-image"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page6">
            <div class="question-container">
                <h3>Question 5</h3>
                <div class="question-text">
                    <p>Three identical blocks each take a different path from a height \( h \) to the ground. Block \( A \) is released from rest and falls vertically. Block \( B \) is released from rest and slides down a frictionless incline. Block \( C \) is projected horizontally with an initial speed \( v \).</p>
                    <img src="images/image14.png" alt="Diagram showing the paths of the blocks" class="question-image">
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(5, 0)">
                        <p>A) A</p>
                    </div>
                    <div class="option" onclick="selectOption(5, 1)">
                        <p>B) B</p>
                    </div>
                    <div class="option" onclick="selectOption(5, 2)">
                        <p>C) C</p>
                    </div>
                    <div class="option" onclick="selectOption(5, 3)">
                        <p>D) The blocks take the same time to reach the ground.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page7">
            <div class="question-container">
                <h3>Question 6</h3>
                <div class="question-text">
                    <p>Which block has the greatest speed just before hitting the ground?</p>
                    <img src="images/image14.png" alt="Diagram showing the paths of the blocks" class="question-image">
                </div>
                <div class="options-container">
                    <div class="option" onclick="selectOption(6, 0)">
                        <p>A) A</p>
                    </div>
                    <div class="option" onclick="selectOption(6, 1)">
                        <p>B) B</p>
                    </div>
                    <div class="option" onclick="selectOption(6, 2)">
                        <p>C) C</p>
                    </div>
                    <div class="option" onclick="selectOption(6, 3)">
                        <p>D) The blocks reach the ground with the same speed.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="navigation">
        <button class="nav-button" id="prevBtn">←</button>
        <span class="page-number">Question <span id="currentPage">1</span> of 50</span>
        <button class="nav-button" id="nextBtn">→</button>
        <button class="nav-button" id="submitBtn" style="background-color: #004d00;">Submit Test</button>
    </div>

    <!-- Submission Modal -->
    <div id="submissionModal" class="modal">
        <div class="modal-content">
            <h3>Submit Your Test</h3>
            <p>Please enter your name or choose to submit anonymously:</p>
            <input type="text" id="submitterName" placeholder="Your Name" class="modal-input">
            <div class="modal-buttons">
                <button id="submitAnonymous" class="modal-button">Submit Anonymously</button>
                <button id="submitWithName" class="modal-button">Submit with Name</button>
                <button id="cancelSubmit" class="modal-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentPageIndex = 1;
        const totalPages = 8; // Update total pages
        const answers = new Array(50).fill(null); // Array to store answers

        function updatePage() {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById(`page${currentPageIndex}`).classList.add('active');
            
            // Update the page number display and text
            const pageNumberSpan = document.querySelector('.page-number');
            if (currentPageIndex === 1) {
                pageNumberSpan.textContent = "Page 1 - Instructions";
                document.getElementById('currentPage').textContent = "1";
            } else {
                pageNumberSpan.textContent = `Page ${currentPageIndex} - Question ${currentPageIndex - 1}`;
                document.getElementById('currentPage').textContent = currentPageIndex;
            }
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentPageIndex === 1;
            document.getElementById('nextBtn').disabled = currentPageIndex === totalPages;
        }

        function selectOption(questionNumber, optionIndex) {
            // Remove selected class from all options in the question
            const questionContainer = document.querySelector(`#page${currentPageIndex} .question-container`);
            questionContainer.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            questionContainer.querySelectorAll('.option')[optionIndex].classList.add('selected');
            
            // Store the answer
            answers[questionNumber - 1] = optionIndex;

        }

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPageIndex > 1) {
                currentPageIndex--;
                updatePage();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentPageIndex < totalPages) {
                currentPageIndex++;
                updatePage();
            }
        });

        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentPageIndex > 1) {
                currentPageIndex--;
                updatePage();
            } else if (e.key === 'ArrowRight' && currentPageIndex < totalPages) {
                currentPageIndex++;
                updatePage();
            } else if (e.key >= '1' && e.key <= '4') {
                // Convert key 1-4 to index 0-3
                const optionIndex = parseInt(e.key) - 1;
                if (currentPageIndex > 1) { // Only if we're on a question page
                    selectOption(currentPageIndex - 1, optionIndex);
                }
            }
        });

        document.getElementById('submitBtn').addEventListener('click', () => {
            // Get selected answers
            const answerData = collectAnswers();
            
            // Show the submission modal
            const submissionModal = document.getElementById('submissionModal');
            submissionModal.style.display = 'block';
            
            // Handle submission buttons
            document.getElementById('submitAnonymous').addEventListener('click', () => {
                submitTest(true, answerData);
                submissionModal.style.display = 'none';
            });
            
            document.getElementById('submitWithName').addEventListener('click', () => {
                const name = document.getElementById('submitterName').value.trim();
                if (!name) {
                    alert('Please enter your name or choose to submit anonymously.');
                    return;
                }
                submitTest(false, answerData, name);
                submissionModal.style.display = 'none';
            });
            
            document.getElementById('cancelSubmit').addEventListener('click', () => {
                submissionModal.style.display = 'none';
            });
        });

        function collectAnswers() {
            const answerData = {};
            
            // Collect all answers including unanswered questions
            for (let i = 1; i <= 6; i++) { // Questions 1-6
                const questionNumber = i;
                const selectedOption = document.querySelector(`#page${i+1} .option.selected`);
                
                if (selectedOption) {
                    // Find the index of the selected option
                    const options = document.querySelectorAll(`#page${i+1} .option`);
                    const optionIndex = Array.from(options).indexOf(selectedOption);
                    // Convert index to letter (0->A, 1->B, etc.)
                    answerData[`question_${questionNumber}`] = String.fromCharCode(65 + optionIndex);
                } else {
                    answerData[`question_${questionNumber}`] = "Not answered";
                }
            }
            
            return answerData;
        }

        function submitTest(isAnonymous, answers, providedName) {
            try {
                // Use the provided name if available, otherwise get it from the input field
                const userName = isAnonymous ? 'Anonymous' : (providedName || document.getElementById('submitterName').value.trim());
                
                // Show loading state 
                alert('Processing your submission...');
                
                // Create submission object
            const submission = {
                testType: 'MCQ',
                    testId: 'physics1testmcq',
                timestamp: new Date().toISOString(),
                    name: userName,
                answers: answers
            };

                // Store the current submission temporarily
                sessionStorage.setItem('lastSubmission', JSON.stringify(submission));
                
                // Prompt for GitHub token instead of hardcoding it
                const githubToken = prompt("Please enter the GitHub token to submit your test:", "");
                
                // Check if token was provided
                if (!githubToken) {
                    alert('GitHub token is required for submission. Please try again.');
                    return;
                }
                
                // Set repository details
                const owner = 'Applethings';
                const repo = 'statswebsitewright';
                
                // Directly update the test-results.html file with the submission
                updateTestResultsHTML(owner, repo, githubToken, submission)
                    .then(result => {
                        if (result.success) {
                            alert('Your submission has been successfully published to GitHub! You can view it on the Results page.');
                            
                            // Optionally redirect to the test results page
                            if (confirm('Would you like to view your submission on the results page?')) {
                                window.location.href = 'test-results.html';
                            }
                        } else {
                            throw new Error(result.error || 'Failed to publish to GitHub');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating test results:', error);
                        alert(`Error publishing to GitHub: ${error.message}`);
                    });
            } catch (error) {
                console.error("Unexpected error in submission process:", error);
                alert('An unexpected error occurred. Please try again.');
            }
        }

        // Function to directly update the test-results.html file with the submission
        async function updateTestResultsHTML(owner, repo, token, submission) {
            try {
                const filePath = 'test-results.html';
                
                // First, fetch the current content of the file
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`Failed to fetch ${filePath}: ${getResponse.status}`);
                }
                
                const fileData = await getResponse.json();
                const content = atob(fileData.content);
                const sha = fileData.sha;
                
                // Determine the subject based on the testId
                let subject = "AP Physics 1";
                if (submission.testId.includes('physics1')) {
                    subject = "AP Physics 1";
                }
                // Add more subject mappings as needed for future tests
                
                // Determine if it's FRQ or MCQ
                const testType = submission.testType;
                
                // Format the submission data for display
                const submissionHTML = formatSubmissionHTML(submission);
                
                // Update the JavaScript data structure
                let updatedContent = updateJavaScriptData(content, subject, submission);
                
                // Update the display containers
                const subjectDivId = subject.toLowerCase().replace(/\s+/g, '-');
                
                // Find or create the container for this subject
                if (!updatedContent.includes(`id="${subjectDivId}"`)) {
                    // Subject doesn't exist yet, add it to the test categories
                    updatedContent = addSubjectCategory(updatedContent, subject, subjectDivId);
                } else {
                    // Update the counter for the subject
                    updatedContent = updateSubjectCounter(updatedContent, subject, subjectDivId, testType);
                }
                
                // Add the submission to the appropriate container
                const containerId = `submissions-${testType.toLowerCase()}-${subjectDivId}`;
                if (!updatedContent.includes(`id="${containerId}"`)) {
                    // Container doesn't exist, create it
                    updatedContent = addSubmissionContainer(updatedContent, containerId, submissionHTML, subject, testType);
                } else {
                    // Container exists, add to it
                    updatedContent = addToSubmissionContainer(updatedContent, containerId, submissionHTML);
                }
                
                // Base64 encode the content properly for non-ASCII characters
                // This fixes the "Failed to execute 'btoa' on 'Window'" error
                const base64Content = utf8ToBase64(updatedContent);
                
                // Update the file on GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add ${testType} submission from ${submission.name} for ${subject}`,
                        content: base64Content,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(`Failed to update ${filePath}: ${errorData.message}`);
                }
                
                console.log(`Successfully updated test-results.html with ${testType} submission for ${subject}`);
                return { success: true };
            } catch (error) {
                console.error('Error updating test-results.html:', error);
                alert(`Error publishing to GitHub: ${error.message}`);
                return { success: false, error: error.message };
            }
        }
        
        // Function to convert UTF-8 string to base64
        function utf8ToBase64(str) {
            try {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (e) {
                console.error("Encoding error:", e);
                // Fallback method if the above fails
                return btoa(unescape(encodeURIComponent(str)));
            }
        }
        
        // Helper function to format a submission as HTML
        function formatSubmissionHTML(submission) {
            const formattedDate = new Date(submission.timestamp).toLocaleString();
            
            // Format text answers (everything except canvas_data)
            let textAnswers = '';
            if (submission.answers) {
                textAnswers = Object.entries(submission.answers)
                    .filter(([key]) => key !== 'canvas_data')
                    .map(([key, value]) => {
                        // For multiple choice, convert question_1 to Q1, etc.
                        const questionLabel = key.replace('question_', 'Q');
                        return `
                            <div class="answer">
                                <strong>${questionLabel}:</strong>
                                <span>${value || 'No answer provided'}</span>
                            </div>
                        `;
                    }).join('');
            }
            
            // Format canvas drawings if they exist
            let canvasHTML = '';
            if (submission.answers && submission.answers.canvas_data) {
                canvasHTML = `
                    <div class="canvas-container">
                        <h4>Drawings:</h4>
                        <div class="canvas-grid">
                            ${Object.entries(submission.answers.canvas_data)
                                .map(([key, value]) => {
                                    let displayName = key;
                                    switch(key) {
                                        case 'positionGraph': displayName = 'Position vs. Time'; break;
                                        case 'velocityGraph': displayName = 'Velocity vs. Time'; break;
                                        case 'gridGraph': displayName = 'Data Grid'; break;
                                        case 'forceT1': displayName = 'Force Diagram (t₁)'; break;
                                        case 'forceT2': displayName = 'Force Diagram (t₂)'; break;
                                        default: displayName = key.replace(/([A-Z])/g, ' $1').trim();
                                    }
                                    
                                    // Handle both image data and text messages
                                    if (typeof value === 'string' && value.startsWith('data:image/')) {
                                        return `
                                            <div class="canvas-item">
                                                <img src="${value}" alt="${displayName}" onclick="zoomImage(this)" style="max-width: 100%; border: 1px solid #ccc;">
                                                <div class="canvas-label">${displayName}</div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="canvas-item">
                                                <div style="padding: 30px; text-align: center; background-color: #f8f8f8; color: #666; border: 1px dashed #ccc;">
                                                    ${value}
                                                </div>
                                                <div class="canvas-label">${displayName}</div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Create the complete submission HTML
            return `
                <div class="submission" data-timestamp="${submission.timestamp}">
                    <div class="submission-header">
                        <div class="submitter">Submitted by: ${submission.name}</div>
                        <div>
                            <span class="timestamp">Date: ${formattedDate}</span>
                        </div>
                    </div>
                    ${textAnswers}
                    ${canvasHTML}
                </div>
            `;
        }
        
        // Helper function to update the JavaScript data in the HTML
        function updateJavaScriptData(content, subject, submission) {
            // This just adds it to localStorage on load
            // Add this after the displayTestCategories() call
            
            // Create a safe copy of the submission for JSON stringification
            const safeSubmission = {...submission};
            
            // Handle potential large canvas data that might cause JSON.stringify to fail
            if (safeSubmission.answers && safeSubmission.answers.canvas_data) {
                let canvasDataDescriptions = {};
                
                for (const [key, value] of Object.entries(safeSubmission.answers.canvas_data)) {
                    // If it's a large data URL (image), replace with a description
                    if (typeof value === 'string' && value.startsWith('data:image/') && value.length > 50000) {
                        canvasDataDescriptions[key] = `[Image data for ${key} - size: ${Math.round(value.length/1024)}KB]`;
                    } else {
                        canvasDataDescriptions[key] = value;
                    }
                }
                
                // Replace the large canvas data with descriptions
                safeSubmission.answers.canvas_data = canvasDataDescriptions;
            }
            
            // Create the script with a safer JSON string
            let scriptContent;
            try {
                scriptContent = `
                    // Add newest submission to localStorage
                    (function() {
                        let allSubmissions = JSON.parse(localStorage.getItem('allTestSubmissions') || '{}');
                        if (!allSubmissions['${subject}']) {
                            allSubmissions['${subject}'] = [];
                        }
                        // Check if submission already exists
                        const exists = allSubmissions['${subject}'].some(s => 
                            s.name === '${submission.name}' && 
                            s.timestamp === '${submission.timestamp}' &&
                            s.testType === '${submission.testType}'
                        );
                        if (!exists) {
                            allSubmissions['${subject}'].push(${JSON.stringify(safeSubmission)});
                            localStorage.setItem('allTestSubmissions', JSON.stringify(allSubmissions));
                        }
                    })();
                `;
            } catch (error) {
                console.error('Error stringifying submission:', error);
                scriptContent = `
                    // Add newest submission to localStorage (metadata only due to size limits)
                    (function() {
                        let allSubmissions = JSON.parse(localStorage.getItem('allTestSubmissions') || '{}');
                        if (!allSubmissions['${subject}']) {
                            allSubmissions['${subject}'] = [];
                        }
                        // Add submission metadata only
                        const exists = allSubmissions['${subject}'].some(s => 
                            s.name === '${submission.name}' && 
                            s.timestamp === '${submission.timestamp}' &&
                            s.testType === '${submission.testType}'
                        );
                        if (!exists) {
                            allSubmissions['${subject}'].push({
                                name: '${submission.name}',
                                testType: '${submission.testType}',
                                timestamp: '${submission.timestamp}',
                                testId: '${submission.testId}',
                                note: 'Full submission data too large for localStorage'
                            });
                            localStorage.setItem('allTestSubmissions', JSON.stringify(allSubmissions));
                        }
                    })();
                `;
            }
            
            return content.replace('displayTestCategories();', `displayTestCategories();\n        ${scriptContent}`);
        }
        
        // Helper function to add a new subject category
        function addSubjectCategory(content, subject, subjectDivId) {
            const categoryHTML = `
            <div class="test-category" id="${subjectDivId}" onclick="showTestTypes('${subject}')">
                <h2>${subject}</h2>
                <p>0 FRQ submissions, 0 MCQ submissions</p>
            </div>`;
            
            return content.replace('<div class="test-selection-container" id="testCategories">', 
                `<div class="test-selection-container" id="testCategories">\n                ${categoryHTML}`);
        }
        
        // Helper function to update the counter for a subject
        function updateSubjectCounter(content, subject, subjectDivId, testType) {
            const regex = new RegExp(`<div class="test-category" id="${subjectDivId}"[^>]*>[\\s\\S]*?<p>(\\d+) FRQ submissions, (\\d+) MCQ submissions</p>`);
            const match = content.match(regex);
            
            if (match) {
                let frqCount = parseInt(match[1]);
                let mcqCount = parseInt(match[2]);
                
                if (testType === 'FRQ') {
                    frqCount++;
                } else {
                    mcqCount++;
                }
                
                return content.replace(
                    `<p>${match[1]} FRQ submissions, ${match[2]} MCQ submissions</p>`,
                    `<p>${frqCount} FRQ submissions, ${mcqCount} MCQ submissions</p>`
                );
            }
            
            return content;
        }
        
        // Helper function to add a new submission container for a subject/type
        function addSubmissionContainer(content, containerId, submissionHTML, subject, testType) {
            const containerHTML = `
            <div id="${containerId}" class="submission-type-container">
                <h3>${testType === 'FRQ' ? 'Free Response' : 'Multiple Choice'} Submissions</h3>
                ${submissionHTML}
            </div>`;
            
            return content.replace('<div class="submissions-container" id="submissionsContainer">', 
                `<div class="submissions-container" id="submissionsContainer">\n                ${containerHTML}`);
        }
        
        // Helper function to add a submission to an existing container
        function addToSubmissionContainer(content, containerId, submissionHTML) {
            const regex = new RegExp(`<div id="${containerId}" class="submission-type-container">[\\s\\S]*?<h3>[^<]*</h3>`);
            const match = content.match(regex);
            
            if (match) {
                return content.replace(
                    match[0],
                    `${match[0]}\n                    ${submissionHTML}`
                );
            }
            
            return content;
        }
    </script>
</body>
</html> 
