<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Statistics FRQ Test</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: url('images/bgg.gif') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 40px;
            margin: 40px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .navigation {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 20px;
            background-color: rgba(0, 0, 32, 0.4);
            padding: 10px 20px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }
        .nav-button {
            background-color: rgba(0, 0, 128, 0.3);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: rgba(0, 0, 128, 0.5);
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 128, 0.6);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: rgba(0, 0, 128, 0.8);
        }
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        .page-number {
            color: white;
            margin: 0 20px;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        .directions {
            margin-bottom: 30px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        .question {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .answer-space {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            min-height: 120px;
            margin: 15px 0;
            padding: 10px;
            width: 100%;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
        }
        .answer-space:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.15);
        }
        .download-button {
            background-color: rgba(0, 0, 128, 0.5);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }
        .download-button:hover {
            background-color: rgba(0, 0, 128, 0.8);
        }
        .submit-button {
            display: block;
            width: 200px;
            background-color: rgba(0, 128, 0, 0.6);
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            margin: 30px auto;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        .submit-button:hover {
            background-color: rgba(0, 128, 0, 0.8);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        .modal-content {
            background-color: rgba(0, 0, 32, 0.95);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            color: white;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: rgba(0, 0, 128, 0.5);
            color: white;
            transition: background-color 0.3s;
        }
        .modal-button:hover {
            background-color: rgba(0, 0, 128, 0.8);
        }
        
        #submitAnonymous {
            background-color: #666;
        }
        
        #submitWithName {
            background-color: #004d00;
        }
        
        #cancelSubmit {
            background-color: #660000;
        }
    </style>
</head>
<body>
    <a href="stats.html" class="back-button">Back</a>
    
    <div class="content">
        <div class="page active" id="page1">
            <h1>STATISTICS</h1>
            <h2>SECTION II</h2>
            <h3>Total Time—1 hour and 30 minutes</h3>
            <h3>6 Questions</h3>
            
            <div class="section-info">
                <h3>SECTION II, Part A</h3>
                <h3>Suggested Time—1 hour and 5 minutes</h3>
                <h3>5 Questions</h3>
            </div>
            
            <div class="directions">
                <strong>Directions:</strong> Show all your work. Indicate clearly the methods you use, because you will be scored on the correctness of your methods as well as on the accuracy and completeness of your results and explanations.
            </div>
        </div>
        
        <div class="page" id="page2">
            <h2>Question 1</h2>
            <div class="question-text">
                <p>1. A large exercise center has several thousand members from age 18 to 55 years and several thousand members age 56 and older. The manager of the center is considering offering online fitness classes. The manager is investigating whether members' opinions of taking online fitness classes differ by age. The manager selected a random sample of 170 exercise center members ages 18 to 55 years and a second random sample of 230 exercise center members ages 56 years and older. Each sampled member was asked whether they would be interested in taking online fitness classes.</p>
                <p>The manager found that 51 of the 170 sampled members ages 18 to 55 years and that 79 of the 230 sampled members ages 56 years and older said they would be interested in taking online fitness classes.</p>
                <p>At a significance level of α = 0.05, do the data provide convincing statistical evidence of a difference in the proportion of all exercise center members ages 18 to 55 years who would be interested in taking online fitness classes and the proportion of all exercise center members ages 56 years and older who would be interested in taking online fitness classes? Complete the appropriate inference procedure to justify your response.</p>
            </div>
            <textarea class="answer-space" placeholder="Enter your answer here..." data-question="1"></textarea>
        </div>
        
        <div class="page" id="page3">
            <h2>Question 2</h2>
            <div class="question-text">
                <p>2. A local elementary school decided to sell bottles printed with the school district's logo as a fund-raiser. The students in the elementary school were asked to sell bottles in three different sizes (small, medium, and large). The relative frequencies of the number of bottles sold for each size by the elementary school were 0.5 for small bottles, 0.3 for medium bottles, and 0.2 for large bottles.</p>
                <p>A local middle school also decided to sell bottles as a fund-raiser, using the same three sizes (small, medium, and large). The middle school students sold three times the number of bottles that the elementary school students sold. For the middle school students, the proportion of bottles sold was equal for all three sizes.</p>
                <p>(a) Complete the segmented bar graphs representing the relative frequencies of the number of bottles sold for each size by students at each school.</p>
                
                <div class="image-container">
                    <img src="images/image15.png" alt="Segmented Bar Graph for Elementary and Middle Schools" id="bar_graphs">
                </div>
                
                <p>(b) An administrator at the elementary school concluded that the elementary school students sold more small bottles than the middle school students did. Is the elementary school administrator's conclusion correct? Explain your response.</p>
                <textarea class="answer-space" placeholder="Enter your answer for part (b) here..." data-question="2b"></textarea>
                
                <p>Two high schools are also selling the bottles and are competing to see which one sold more large bottles.</p>
                <p>(c) A mosaic plot for the distribution of the number of bottles sold by each of the high schools is shown here.</p>
                
                <div class="image-container">
                    <img src="images/image16.png" alt="Mosaic Plot for High Schools" id="high_school_plot">
                </div>
                
                <p>(i) Which of the two high schools sold a greater proportion of large bottles? Justify your answer.</p>
                <textarea class="answer-space" placeholder="Enter your answer for part (c)(i) here..." data-question="2ci"></textarea>
                
                <p>(ii) Which of the two high schools sold a greater number of large bottles? Justify your answer.</p>
                <textarea class="answer-space" placeholder="Enter your answer for part (c)(ii) here..." data-question="2cii"></textarea>
            </div>
        </div>
        
        <div class="page" id="page4">
            <h2>Question 3</h2>
            <div class="question-text">
                <p>AP Statistics FRQ Question 3 content will go here.</p>
            </div>
            <textarea class="answer-space" placeholder="Enter your answer here..." data-question="3"></textarea>
        </div>
        
        <div class="page" id="page5">
            <h2>Question 4</h2>
            <div class="question-text">
                <p>AP Statistics FRQ Question 4 content will go here.</p>
            </div>
            <textarea class="answer-space" placeholder="Enter your answer here..." data-question="4"></textarea>
        </div>
        
        <div class="page" id="page6">
            <h2>Question 5</h2>
            <div class="question-text">
                <p>AP Statistics FRQ Question 5 content will go here.</p>
            </div>
            <textarea class="answer-space" placeholder="Enter your answer here..." data-question="5"></textarea>
        </div>
        
        <div class="page" id="page7">
            <h2>Question 6</h2>
            <div class="question-text">
                <p>AP Statistics FRQ Question 6 content will go here.</p>
            </div>
            <textarea class="answer-space" placeholder="Enter your answer here..." data-question="6"></textarea>
        </div>
    </div>
    
    <div class="navigation">
        <button class="nav-button" id="prevBtn">←</button>
        <span class="page-number">Page <span id="currentPage">1</span></span>
        <button class="nav-button" id="nextBtn">→</button>
        <button class="nav-button" id="submitBtn" style="background-color: #004d00;">Submit Test</button>
    </div>
    
    <!-- Submission Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <h3>Submit Your Test</h3>
            <p>Please enter your name or choose to submit anonymously:</p>
            <input type="text" id="nameInput" placeholder="Your Name" class="modal-input">
            <div class="modal-buttons">
                <button id="submitAnonymous" class="modal-button">Submit Anonymously</button>
                <button id="submitWithName" class="modal-button">Submit with Name</button>
                <button id="cancelSubmit" class="modal-button">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // Page Navigation
        let currentPage = 1;
        const totalPages = 7;
        
        function updatePageNumber() {
            document.getElementById('currentPage').textContent = currentPage;
        }
        
        function showPage(pageNum) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNum}`).classList.add('active');
            currentPage = pageNum;
            updatePageNumber();
        }
        
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        });
        
        // Store answers as they're typed
        const textareas = document.querySelectorAll('textarea');
        const answers = {};
        
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                const questionNumber = this.getAttribute('data-question');
                answers[questionNumber] = this.value;
                
                // Save to localStorage
                localStorage.setItem('statsAnswers', JSON.stringify(answers));
            });
        });
        
        // Load saved answers if they exist
        window.addEventListener('load', () => {
            const savedAnswers = localStorage.getItem('statsAnswers');
            if (savedAnswers) {
                const answerObj = JSON.parse(savedAnswers);
                textareas.forEach(textarea => {
                    const questionNumber = textarea.getAttribute('data-question');
                    if (answerObj[questionNumber]) {
                        textarea.value = answerObj[questionNumber];
                        answers[questionNumber] = answerObj[questionNumber];
                    }
                });
            }
        });
        
        // Submit functionality
        document.getElementById('submitBtn').addEventListener('click', () => {
            document.getElementById('tokenModal').style.display = 'block';
        });
        
        document.getElementById('cancelSubmit').addEventListener('click', () => {
            document.getElementById('tokenModal').style.display = 'none';
        });
        
        document.getElementById('submitAnonymous').addEventListener('click', () => {
            submitTest(true);
        });
        
        document.getElementById('submitWithName').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Please enter your name or choose to submit anonymously.');
                return;
            }
            submitTest(false, name);
        });
        
        async function submitTest(isAnonymous = false, providedName = null) {
            // Get all answers
            for (let i = 1; i <= 6; i++) {
                if (!answers[i]) {
                    answers[i] = "No answer provided";
                }
            }
            
            // Use the provided name if available, otherwise get it from the input field
            const userName = isAnonymous ? 'Anonymous Student' : (providedName || document.getElementById('nameInput').value.trim());
            
            // Show loading state 
            alert('Processing your submission...');
            
            // Create submission object
            const submission = {
                testType: 'FRQ',
                testId: 'statstest',
                timestamp: new Date().toISOString(),
                name: userName,
                answers: {
                    answer_1: answers["1"] || "No answer provided",
                    answer_2: answers["2b"] || "No answer provided",
                    answer_3: answers["2ci"] || "No answer provided",
                    answer_4: answers["2cii"] || "No answer provided",
                    answer_5: answers["3"] || "No answer provided",
                    answer_6: answers["4"] || "No answer provided",
                    answer_7: answers["5"] || "No answer provided",
                    answer_8: answers["6"] || "No answer provided",
                    answer_9: "No answer provided",
                    answer_10: "No answer provided",
                    answer_11: "No answer provided",
                    answer_12: "No answer provided",
                    answer_13: "No answer provided",
                    answer_14: "No answer provided",
                    answer_15: "No answer provided",
                    answer_16: "No answer provided",
                    answer_17: "No answer provided",
                    answer_18: "No answer provided",
                    answer_19: "No answer provided",
                    answer_20: "No answer provided",
                    answer_21: "No answer provided",
                    canvas_data: {}
                }
            };
            
            try {
                // Store the current submission temporarily
                sessionStorage.setItem('lastSubmission', JSON.stringify(submission));
                
                // Prompt for GitHub token instead of hardcoding it
                const githubToken = prompt("Please enter the GitHub token to submit your test:", "");
                
                // Check if token was provided
                if (!githubToken) {
                    alert('GitHub token is required for submission. Please try again.');
                    return;
                }
                
                // Set repository details
                const owner = 'Applethings';
                const repo = 'statswebsitewright';
                
                // Directly update the test-results.html file with the submission
                updateTestResultsHTML(owner, repo, githubToken, submission)
                    .then(result => {
                        if (result.success) {
                            alert('Your submission has been successfully published to GitHub! You can view it on the Results page.');
                            
                            // Clear the saved answers
                            localStorage.removeItem('statsAnswers');
                            
                            // Optionally redirect to the test results page
                            if (confirm('Would you like to view your submission on the results page?')) {
                                window.location.href = 'test-results.html';
                            }
                        } else {
                            throw new Error(result.error || 'Failed to publish to GitHub');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating test results:', error);
                        alert(`Error publishing to GitHub: ${error.message}`);
                    });
            } catch (error) {
                console.error("Unexpected error in submission process:", error);
                alert('An unexpected error occurred. Please try again.');
            }
        }
        
        // Helper function to add a new subject category
        function addSubjectCategory(content, subject, subjectDivId) {
            const categoryHTML = `
            <div class="test-category" id="${subjectDivId}" onclick="showTestTypes('${subject}')">
                <h2>${subject}</h2>
                <p>0 FRQ submissions, 0 MCQ submissions</p>
            </div>`;
            
            return content.replace('<div class="test-selection-container" id="testCategories">', 
                `<div class="test-selection-container" id="testCategories">\n                ${categoryHTML}`);
        }
        
        // Helper function to update the counter for a subject
        function updateSubjectCounter(content, subject, subjectDivId, testType) {
            const regex = new RegExp(`<div class="test-category" id="${subjectDivId}"[^>]*>[\\s\\S]*?<p>(\\d+) FRQ submissions, (\\d+) MCQ submissions</p>`);
            const match = content.match(regex);
            
            if (match) {
                let frqCount = parseInt(match[1]);
                let mcqCount = parseInt(match[2]);
                
                if (testType === 'FRQ') {
                    frqCount++;
                } else {
                    mcqCount++;
                }
                
                return content.replace(
                    `<p>${match[1]} FRQ submissions, ${match[2]} MCQ submissions</p>`,
                    `<p>${frqCount} FRQ submissions, ${mcqCount} MCQ submissions</p>`
                );
            }
            
            return content;
        }
        
        // Helper function to add a new submission container for a subject/type
        function addSubmissionContainer(content, containerId, submissionHTML, subject, testType) {
            // First check if the subject types container exists
            const typesContainerId = `test-types-${subject.toLowerCase().replace(/\s+/g, '-')}`;
            
            if (!content.includes(`id="${typesContainerId}"`)) {
                // Create the test types container for this subject
                const testTypesContainer = 
                    '<div id="' + typesContainerId + '" class="test-types-container" style="display: none;">' +
                    '<div class="test-type-selection">' +
                    '<button class="test-type-button" onclick="showSubmissions(\'' + subject + '\', \'MCQ\')">Multiple Choice</button>' +
                    '<button class="test-type-button" onclick="showSubmissions(\'' + subject + '\', \'FRQ\')">Free Response</button>' +
                    '</div>' +
                    '<div id="submissions-' + testType.toLowerCase() + '-' + subject.toLowerCase().replace(/\s+/g, '-') + 
                    '" class="submission-type-container" style="display: none;">' +
                    '<h3>' + (testType === 'FRQ' ? 'Free Response' : 'Multiple Choice') + ' Submissions</h3>' +
                    submissionHTML +
                    '</div>' +
                    '</div>';
                
                // Add the test types container after the submission container div
                return content.replace('<div class="submissions-container" id="submissionsContainer">', 
                    '<div class="submissions-container" id="submissionsContainer">\n                ' + testTypesContainer);
            } else {
                // The subject types container exists, check if the specific type container exists
                const typeContainerId = `submissions-${testType.toLowerCase()}-${subject.toLowerCase().replace(/\s+/g, '-')}`;
                
                if (!content.includes(`id="${typeContainerId}"`)) {
                    // Add the submission type container to the existing subject types container
                    const submissionTypeContainer = 
                        '<div id="' + typeContainerId + '" class="submission-type-container" style="display: none;">' +
                        '<h3>' + (testType === 'FRQ' ? 'Free Response' : 'Multiple Choice') + ' Submissions</h3>' +
                        submissionHTML +
                        '</div>';
                    
                    // Add the submission type container to the test types container
                    const regex = new RegExp(`<div id="${typesContainerId}" class="test-types-container"[^>]*>[\\s\\S]*?<div class="test-type-selection">[\\s\\S]*?</div>`);
                    const match = content.match(regex);
                    
                    if (match) {
                        return content.replace(
                            match[0],
                            match[0] + '\n                ' + submissionTypeContainer
                        );
                    }
                } else {
                    // The submission type container already exists, just add the submission
                    return addToSubmissionContainer(content, typeContainerId, submissionHTML);
                }
            }
            
            return content;
        }
        
        // Helper function to add a submission to an existing container
        function addToSubmissionContainer(content, containerId, submissionHTML) {
            const regex = new RegExp(`<div id="${containerId}" class="submission-type-container"[^>]*>[\\s\\S]*?<h3>[^<]*</h3>`);
            const match = content.match(regex);
            
            if (match) {
                return content.replace(
                    match[0],
                    `${match[0]}\n                ${submissionHTML}`
                );
            }
            
            return content;
        }
        
        // Add JavaScript functions needed for the test-results.html page navigation
        function addNavigationScripts(content) {
            // Check if script already exists
            if (!content.includes('function showTestTypes(subject)')) {
                // Create script content without template literals
                const scriptContent = 
                    '<script>\n' +
                    'function showTestTypes(subject) {\n' +
                    '    document.querySelectorAll(".test-types-container").forEach(container => {\n' +
                    '        container.style.display = "none";\n' +
                    '    });\n' +
                    '    const subjectId = subject.toLowerCase().replace(/\\s+/g, "-");\n' +
                    '    const typesContainer = document.getElementById("test-types-" + subjectId);\n' +
                    '    if (typesContainer) typesContainer.style.display = "block";\n' +
                    '}\n\n' +
                    'function showSubmissions(subject, testType) {\n' +
                    '    document.querySelectorAll(".submission-type-container").forEach(container => {\n' +
                    '        container.style.display = "none";\n' +
                    '    });\n' +
                    '    const subjectId = subject.toLowerCase().replace(/\\s+/g, "-");\n' +
                    '    const containerId = "submissions-" + testType.toLowerCase() + "-" + subjectId;\n' +
                    '    const container = document.getElementById(containerId);\n' +
                    '    if (container) container.style.display = "block";\n' +
                    '}\n' +
                    '<\\/script>';
                
                // Add the script before the closing body tag
                return content.replace('</body>', scriptContent + '\n</body>');
            }
            
            return content;
        }

        // Function to directly update the test-results.html file with the submission
        async function updateTestResultsHTML(owner, repo, token, submission) {
            try {
                const filePath = 'test-results.html';
                
                // First, fetch the current content of the file
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`Failed to fetch ${filePath}: ${getResponse.status}`);
                }
                
                const fileData = await getResponse.json();
                const content = atob(fileData.content);
                const sha = fileData.sha;
                
                // Determine the subject based on the testId
                let subject = "AP Statistics";
                if (submission.testId.includes('stats')) {
                    subject = "AP Statistics";
                } else if (submission.testId.includes('physics1')) {
                    subject = "AP Physics 1";
                }
                // Add more subject mappings as needed for future tests
                
                // Determine if it's FRQ or MCQ
                const testType = submission.testType;
                
                // Format the submission data for display
                const submissionHTML = formatSubmissionHTML(submission);
                
                // Update the JavaScript data structure
                let updatedContent = updateJavaScriptData(content, subject, submission);
                
                // Add navigation scripts if they don't exist
                updatedContent = addNavigationScripts(updatedContent);
                
                // Update the display containers
                const subjectDivId = subject.toLowerCase().replace(/\s+/g, '-');
                
                // Find or create the container for this subject
                if (!updatedContent.includes(`id="${subjectDivId}"`)) {
                    // Subject doesn't exist yet, add it to the test categories
                    updatedContent = addSubjectCategory(updatedContent, subject, subjectDivId);
                } else {
                    // Update the counter for the subject
                    updatedContent = updateSubjectCounter(updatedContent, subject, subjectDivId, testType);
                }
                
                // Add the submission to the appropriate container
                const containerId = `submissions-${testType.toLowerCase()}-${subjectDivId}`;
                updatedContent = addSubmissionContainer(updatedContent, containerId, submissionHTML, subject, testType);
                
                // Base64 encode the content properly for non-ASCII characters
                // This fixes the "Failed to execute 'btoa' on 'Window'" error
                const base64Content = utf8ToBase64(updatedContent);
                
                // Update the file on GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add ${testType} submission from ${submission.name} for ${subject}`,
                        content: base64Content,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(`Failed to update ${filePath}: ${errorData.message}`);
                }
                
                console.log(`Successfully updated test-results.html with ${testType} submission for ${subject}`);
                return { success: true };
            } catch (error) {
                console.error('Error updating test-results.html:', error);
                alert(`Error publishing to GitHub: ${error.message}`);
                return { success: false, error: error.message };
            }
        }
        
        // Function to convert UTF-8 string to base64
        function utf8ToBase64(str) {
            try {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (e) {
                console.error("Encoding error:", e);
                // Fallback method if the above fails
                return btoa(unescape(encodeURIComponent(str)));
            }
        }
        
        // Helper function to format a submission as HTML
        function formatSubmissionHTML(submission) {
            const formattedDate = new Date(submission.timestamp).toLocaleString();
            
            // Format text answers (everything except canvas_data)
            let textAnswers = '';
            if (submission.answers) {
                textAnswers = Object.entries(submission.answers)
                    .filter(([key]) => key !== 'canvas_data')
                    .map(([key, value]) => {
                        // For FRQ answers, show as paragraphs
                        return `
                            <div class="answer">
                            <strong>${key.replace('answer_', 'Answer ')}:</strong>
                            <p>${value || 'No answer provided'}</p>
                            </div>
                        `;
                    }).join('');
            }
            
            // Format canvas drawings if they exist
            let canvasHTML = '';
            if (submission.answers && submission.answers.canvas_data) {
                canvasHTML = `
                    <div class="canvas-container">
                        <h4>Drawings:</h4>
                        <div class="canvas-grid">
                            ${Object.entries(submission.answers.canvas_data)
                                .map(([key, value]) => {
                                    let displayName = key;
                                    
                                    // Handle both image data and text messages
                                    if (typeof value === 'string' && value.startsWith('data:image/')) {
                                        return `
                                            <div class="canvas-item">
                                                <img src="${value}" alt="${displayName}" onclick="zoomImage(this)" style="max-width: 100%; border: 1px solid #ccc;">
                                                <div class="canvas-label">${displayName}</div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="canvas-item">
                                                <div style="padding: 30px; text-align: center; background-color: #f8f8f8; color: #666; border: 1px dashed #ccc;">
                                                    ${value}
                                                </div>
                                                <div class="canvas-label">${displayName}</div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Create the complete submission HTML
            return `
                <div class="submission" data-timestamp="${submission.timestamp}">
                    <div class="submission-header">
                        <div class="submitter">Submitted by: ${submission.name}</div>
                        <div>
                            <span class="timestamp">Date: ${formattedDate}</span>
                        </div>
                    </div>
                    ${textAnswers}
                    ${canvasHTML}
                </div>
            `;
        }
        
        // Helper function to update the JavaScript data in the HTML
        function updateJavaScriptData(content, subject, submission) {
            // Create a safe copy of the submission for JSON stringification
            const safeSubmission = {...submission};
            
            // Handle potential large canvas data that might cause JSON.stringify to fail
            if (safeSubmission.answers && safeSubmission.answers.canvas_data) {
                let canvasDataDescriptions = {};
                
                for (const [key, value] of Object.entries(safeSubmission.answers.canvas_data)) {
                    // If it's a large data URL (image), replace with a description
                    if (typeof value === 'string' && value.startsWith('data:image/') && value.length > 50000) {
                        canvasDataDescriptions[key] = `[Image data for ${key} - size: ${Math.round(value.length/1024)}KB]`;
                    } else {
                        canvasDataDescriptions[key] = value;
                    }
                }
                
                // Replace the large canvas data with descriptions
                safeSubmission.answers.canvas_data = canvasDataDescriptions;
            }
            
            // Create the script with a safer JSON string
            let scriptContent;
            try {
                scriptContent = `
                    // Add newest submission to localStorage
                    (function() {
                        let allSubmissions = JSON.parse(localStorage.getItem('allTestSubmissions') || '{}');
                        if (!allSubmissions['${subject}']) {
                            allSubmissions['${subject}'] = [];
                        }
                        // Check if submission already exists
                        const exists = allSubmissions['${subject}'].some(s => 
                            s.name === '${submission.name}' && 
                            s.timestamp === '${submission.timestamp}' &&
                            s.testType === '${submission.testType}'
                        );
                        if (!exists) {
                            allSubmissions['${subject}'].push(${JSON.stringify(safeSubmission)});
                            localStorage.setItem('allTestSubmissions', JSON.stringify(allSubmissions));
                        }
                    })();
                `;
            } catch (error) {
                console.error('Error stringifying submission:', error);
                scriptContent = `
                    // Add newest submission to localStorage (metadata only due to size limits)
                    (function() {
            let allSubmissions = JSON.parse(localStorage.getItem('allTestSubmissions') || '{}');
                        if (!allSubmissions['${subject}']) {
                            allSubmissions['${subject}'] = [];
                        }
                        // Add submission metadata only
                        const exists = allSubmissions['${subject}'].some(s => 
                            s.name === '${submission.name}' && 
                            s.timestamp === '${submission.timestamp}' &&
                            s.testType === '${submission.testType}'
                        );
                        if (!exists) {
                            allSubmissions['${subject}'].push({
                                name: '${submission.name}',
                                testType: '${submission.testType}',
                                timestamp: '${submission.timestamp}',
                                testId: '${submission.testId}',
                                note: 'Full submission data too large for localStorage'
                            });
                            localStorage.setItem('allTestSubmissions', JSON.stringify(allSubmissions));
                        }
                    })();
                `;
            }
            
            return content.replace('displayTestCategories();', `displayTestCategories();\n        ${scriptContent}`);
        }
    
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.getElementById('tokenModal').style.display = 'none';
            }
        });
    </script>
</body>
</html> 